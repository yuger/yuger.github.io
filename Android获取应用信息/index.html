<html>
<head>
	
	<title>Android获取应用信息</title>
	<meta name="keywords" content="My Blog, Spider Bitch!" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<p>我们的手机里面往往安装了大量的App，比如在我的一台测试机里就安装了六百多个应用，可是数量多了就不记得自己安装过哪些，需要使用的时候还忘记名字，一个一个找起来非常麻烦，如何解决这个问题，我认为还需要一个工具应用，用于管理所有安装过的App，在用户需要某个App的时候能很快将它找出来。</p>
<h3 id="获取应用信息"><a href="#获取应用信息" class="headerlink" title="获取应用信息"></a>获取应用信息</h3><p>Android系统提供了<code>PackageInfo</code>类，每个安装的App都对应一个<code>PackageInfo</code>类对象，我们可以通过该对象获取App的名称、包名、安装时间、最近更新时间、Apk文件大小等信息，示例代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">PackageManager packageManager = getPackageManager();</div><div class="line">List&lt;PackageInfo&gt; packages = packageManager.getInstalledPackages(PackageManager.GET_PERMISSIONS);</div><div class="line">Iterator&lt;PackageInfo&gt; iterator = packages.iterator();</div><div class="line">ArrayList&lt;AppInfo&gt; packageInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</div><div class="line">    PackageInfo packageInfo = iterator.next();</div><div class="line">    <span class="keyword">if</span> ((packageInfo.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) &lt;= <span class="number">0</span>) &#123;</div><div class="line">        AppInfo appInfo = <span class="keyword">new</span> AppInfo();</div><div class="line">        appInfo.setAppName(packageInfo.applicationInfo.loadLabel(packageManager).toString());<span class="comment">//应用名称</span></div><div class="line">        appInfo.setPackageName(packageInfo.packageName);<span class="comment">// 包名</span></div><div class="line">        appInfo.setInstall(packageInfo.firstInstallTime);<span class="comment">// 安装时间</span></div><div class="line">        appInfo.setUpdate(packageInfo.lastUpdateTime);<span class="comment">// 最近更新</span></div><div class="line">        appInfo.setSize(<span class="keyword">new</span> File(packageInfo.applicationInfo.sourceDir).length());<span class="comment">// 大小</span></div><div class="line">        packageInfoList.add(appInfo);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先要获取PackageManager对象，调用它的getInstalledPackages(int )方法获取PackageInfo的队列，包括系统应用和普通应用。我们对该队列进行遍历，获取每个应用的具体信息。这里用一个<code>AppInfo</code>类封装每个应用获取到的数据，最终添加到<code>ArrayList&lt;AppInfo&gt;</code>集合中。可以看到以上代码段中有<code>if ((packageInfo.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) &lt;= 0) {</code>的判断，这是为了过滤掉系统应用，因为我们一般只关心自己安装的应用。获取ArrayList数据后通过RecyclerAdapter将每一项数据显示在RecyclerView中。</p>
<h3 id="搜索功能的实现"><a href="#搜索功能的实现" class="headerlink" title="搜索功能的实现"></a>搜索功能的实现</h3><p>上文提到我有一台测试机安装了六百多个应用，此时要寻找某一个应用则必须使用搜索功能不可了，所以我们来实现该功能。</p>
<p>Android Support v7包提供了<code>android.support.v7.widget.SearchView</code>类，我们看看它的定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchView</span> <span class="keyword">extends</span> <span class="title">LinearLayoutCompat</span> <span class="keyword">implements</span> <span class="title">CollapsibleActionView</span> </span>&#123;</div></pre></td></tr></table></figure></p>
<p>一个自定义ViewGroup, 所以UI方面已经实现了，但是具体的逻辑还得我们自己实现。我们把SearchView放在Toolbar里面，放在菜单按钮旁边，所以首先需要在<menu>标签里面定义：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">item</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/app_search"</span></div><div class="line">    <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_search_white_24dp"</span></div><div class="line">    <span class="attr">android:imeOptions</span>=<span class="string">"actionSearch"</span></div><div class="line">    <span class="attr">android:inputType</span>=<span class="string">"textCapWords"</span></div><div class="line">    <span class="attr">android:title</span>=<span class="string">"@android:string/search_go"</span></div><div class="line">    <span class="attr">app:actionViewClass</span>=<span class="string">"android.support.v7.widget.SearchView"</span></div><div class="line">    <span class="attr">app:showAsAction</span>=<span class="string">"always|collapseActionView"</span>/&gt;</div></pre></td></tr></table></figure></menu></p>
<p>可以自己实现图标，实际上系统也有默认实现，只是比较丑。</p>
<p>然后就是在Activity的onCreateOptionsMenu()中加载<menu>布局，并获取SearchView对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</div><div class="line">    getMenuInflater().inflate(R.menu.activity_home_title, menu);</div><div class="line">    MenuItem searchItem = menu.findItem(R.id.app_search);</div><div class="line">    SearchView mSearchView = (SearchView) MenuItemCompat.getActionView(searchItem);</div><div class="line">    <span class="keyword">if</span> (mSearchView!= <span class="keyword">null</span>) &#123;</div><div class="line">        mSearchView.setOnQueryTextListener(<span class="keyword">new</span> SearchView.OnQueryTextListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextChange</span><span class="params">(String newText)</span> </span>&#123;</div><div class="line">                adapter.getFilter().filter(newText);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextSubmit</span><span class="params">(String query)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onCreateOptionsMenu(menu);</div><div class="line">&#125;</div></pre></td></tr></table></figure></menu></p>
<p>可以看到获取SearchView对象之后注册了<code>SearchView.OnQueryTextListener</code>接口并实现<code>onQueryTextChange</code>和<code>onQueryTextSubmit</code>回调方法，当用户输入文字的时候会调用<code>onQueryTextChange</code>方法，而且每输入一个字符都会调用，并传递String类型的数据。上面adapter即为<code>RecyclerView.Adapter</code>的子类，定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRecyclerAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">MyRecyclerAdapter</span>.<span class="title">MyViewHolder</span>&gt; <span class="keyword">implements</span> <span class="title">Filterable</span></span>&#123;</div></pre></td></tr></table></figure></p>
<p>同时还实现了<code>Filterable</code>接口，使得该Adapter可以对元素内容进行过滤。<code>Filterable</code>有一个抽象方法<code>public Filter getFilter()</code>返回<code>Filter</code>对象并调用它的<code>filter(String newText)</code>方法，<code>getFilter()</code>方法的具体实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Filter mFilter;</div><div class="line">    <span class="keyword">private</span> String mConstraint;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Filter <span class="title">getFilter</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mFilter == <span class="keyword">null</span>) &#123;</div><div class="line">            mFilter = <span class="keyword">new</span> Filter() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">protected</span> FilterResults <span class="title">performFiltering</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</div><div class="line">                    String constraint = charSequence.toString().toLowerCase();</div><div class="line">                    mConstraint = constraint;</div><div class="line">                    FilterResults filterResults = <span class="keyword">new</span> FilterResults();</div><div class="line">                    <span class="keyword">if</span> (constraint.length() == <span class="number">0</span>) &#123;</div><div class="line">                        filterResults.count = <span class="number">0</span>;</div><div class="line">                        filterResults.values = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">return</span> filterResults;</div><div class="line">                    &#125;</div><div class="line">                    ArrayList&lt;AppInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(mAdapterList.size());</div><div class="line">                    <span class="keyword">for</span> (AppInfo item : mAdapterList) &#123;</div><div class="line">                        <span class="keyword">if</span> (item.getAppName().toLowerCase().contains(constraint) || item.getPackageName().contains(constraint)) &#123;</div><div class="line">                            list.add(item);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    filterResults.count = list.size();</div><div class="line">                    filterResults.values = list;</div><div class="line">                    <span class="keyword">return</span> filterResults;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">publishResults</span><span class="params">(CharSequence charSequence, FilterResults filterResults)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (filterResults.values == <span class="keyword">null</span>) &#123;</div><div class="line">                        packageInfoList = mAdapterList;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        packageInfoList = (ArrayList&lt;AppInfo&gt;) filterResults.values;</div><div class="line">                    &#125;</div><div class="line">                    notifyDataSetChanged();</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mFilter;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>packageInfoList</code>和<code>mAdapterList</code>都是第一步获取到的ArrayList<appinfo>,  <code>mConstraint</code>为用户搜索输入的字符串。 在<code>performFiltering</code>回调方法中如果输入字符串的长度不为0，则返回过滤后的FilterResults对象，具体为<code>if (item.getAppName().toLowerCase().contains(constraint) || item.getPackageName().contains(constraint)) {</code> 否则返回一个空数据的FilterResults对象。然后<code>FilterResults</code>对象会传递到<code>publishResults</code>回调方法中，修改了<code>packageInfoList</code>的值，通知Adapter数据已修改并刷新列表，另外我们还需要为刷新后的控件赋值，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (mConstraint != <span class="keyword">null</span> &amp;&amp; appInfo.getAppName().toLowerCase().contains(mConstraint))&#123;</div><div class="line">    holder.appName.setText(getHighlightedText(appInfo.getAppName()));<span class="comment">// 搜索</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    holder.appName.setText(appInfo.getAppName());</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (mConstraint != <span class="keyword">null</span> &amp;&amp; appInfo.getPackageName().contains(mConstraint)) &#123;</div><div class="line">    holder.appPackageName.setText(getHighlightedText(appInfo.getPackageName()));<span class="comment">// 搜索</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    holder.appPackageName.setText(appInfo.getPackageName());</div><div class="line">&#125;</div></pre></td></tr></table></figure></appinfo></p>
<p>当有搜索数据输入时只显示匹配的AppItem的数据。</p>
<p>项目示例：<br><a href="https://play.google.com/store/apps/details?id=com.wxy.appsharp" target="_blank" rel="external"><img src="http://7xqblc.com1.z0.glb.clouddn.com/static/images/googleplay.png" alt=""></a></p>





</body>
</html>