<html>
<head>
	
	<title>Android动态壁纸--夕阳应用</title>
	<meta name="keywords" content="My Blog, Spider Bitch!" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<p>Android动态壁纸可以让手机桌面显得生动活泼有趣，它可以根据用户的手势展现不同的壁纸形态，或者显示动态的信息，曾经是Android系统的特色之一。然而在我的几台Android设备上，Android4.4有四个系统自带动态壁纸；Android5.1有两个系统自带动态壁纸；Android6.0只剩下一个系统自带动态壁纸；而到了Android7.1，已经没有系统自带的动态壁纸了。从这个角度看，动态壁纸变得越来越不受欢迎。当我在Google Play搜寻动态壁纸应用，发现很多都是早几年开发的，多年没有更新了，用户对动态壁纸已经丧失了热情，毕竟现在都是崇尚极简，一张简单的图片就好，用不着那么花哨。从我上架的那个动态壁纸应用来看，也印证了动态壁纸是夕阳应用的观点。本文讨论的是Android动态壁纸开发的知识点。</p>
<p>首先在AndroidManifest.xml文件中添加以下代码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-feature</span></span></div><div class="line">    <span class="attr">android:glEsVersion</span>=<span class="string">"0x00020000"</span></div><div class="line">    <span class="attr">android:required</span>=<span class="string">"true"</span>/&gt;</div><div class="line"><span class="tag">&lt;<span class="name">uses-feature</span></span></div><div class="line">    <span class="attr">android:name</span>=<span class="string">"android.software.live_wallpaper"</span></div><div class="line">    <span class="attr">android:required</span>=<span class="string">"true"</span>/&gt;</div></pre></td></tr></table></figure></p>
<p>表示只有支持设置动态壁纸和OpenGL ES2.0以上的手机才能在Google Play中显示该应用。</p>
<p>动态壁纸由系统提供<code>WallpaperService</code>予以支持，我们看一下<code>WallpaperService</code>的定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WallpaperService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div></pre></td></tr></table></figure></p>
<p>这是一个继承Service的抽象类，因此我们在使用的时候需要继承<code>WallpaperService</code>，然后重写它的抽象方法<code>onCreateEngine()</code>。该方法向系统返回一个<code>WallpaperService.Engine</code>类对象，我们的逻辑就是在Engine类里面完成。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Engine mEngine;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Engine <span class="title">onCreateEngine</span><span class="params">()</span> </span>&#123;</div><div class="line">        mEngine = <span class="keyword">new</span> WallpaperEngine();</div><div class="line">        <span class="keyword">return</span> mEngine;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>向系统返回我们自定义的<code>WallpaperEngine</code>类对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WallpaperEngine</span> <span class="keyword">extends</span> <span class="title">Engine</span> </span>&#123;</div></pre></td></tr></table></figure></p>
<p>继承Engine类实现以下方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> YinYangSurfaceView mGLSurfaceView;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SurfaceHolder surfaceHolder)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(surfaceHolder);</div><div class="line">    mGLSurfaceView = <span class="keyword">new</span> YinYangSurfaceView();</div><div class="line">    setTouchEventsEnabled(<span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line">    mGLSurfaceView.onDestroy();</div><div class="line">    mGLSurfaceView = <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent me)</span> </span>&#123;</div><div class="line">    mGLSurfaceView.onTouch(me);</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onVisibilityChanged</span><span class="params">(<span class="keyword">boolean</span> visible)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onVisibilityChanged(visible);</div><div class="line">    <span class="keyword">if</span> (visible) &#123;</div><div class="line">        mGLSurfaceView.onResume();</div><div class="line">        mGLSurfaceView.requestRender();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mGLSurfaceView.onPause();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里又出现了一个自定义的<code>GLSurfaceView</code>,我们看看它的定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">YinYangSurfaceView</span> <span class="keyword">extends</span> <span class="title">GLSurfaceView</span> <span class="keyword">implements</span> <span class="title">GLSurfaceView</span>.<span class="title">Renderer</span>, <span class="title">Runnable</span> </span>&#123;</div></pre></td></tr></table></figure></p>
<p>这里才是实现动态壁纸具体逻辑的地方，用于加载glsl渲染文件，处理手势交互等。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ByteBuffer mScreenVertices;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">YinYangSurfaceView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(YinYangService.<span class="keyword">this</span>);</div><div class="line">    setEGLContextClientVersion(<span class="number">2</span>);</div><div class="line">    setRenderer(<span class="keyword">this</span>);</div><div class="line">    setRenderMode(GLSurfaceView.RENDERMODE_WHEN_DIRTY);</div><div class="line">    onPause();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">byte</span> SCREEN_COORDS[] = &#123;-<span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, -<span class="number">1</span>&#125;;</div><div class="line">    mScreenVertices = ByteBuffer.allocateDirect(<span class="number">2</span> * <span class="number">4</span>);</div><div class="line">    mScreenVertices.put(SCREEN_COORDS).position(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>构造方法完成初始化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> SurfaceHolder mSurfaceHolder;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SurfaceHolder <span class="title">getHolder</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mSurfaceHolder == <span class="keyword">null</span>) &#123;</div><div class="line">        mSurfaceHolder = mEngine.getSurfaceHolder();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> mSurfaceHolder;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重写<code>getHolder()</code>方法，返回<code>SurfaceHolder</code>类对象。</p>
<p>接下来就是重写几个方法，在其中实现具体逻辑。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 unused)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 unused, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 unused, EGLConfig config)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onTouch</span><span class="params">(MotionEvent me)</span> </span>&#123;</div></pre></td></tr></table></figure></p>
<p>实现案例：<br><a href="https://play.google.com/store/apps/details?id=com.wxy.livewall" target="_blank" rel="external"><img src="http://7xqblc.com1.z0.glb.clouddn.com/static/images/googleplay.png" alt=""></a></p>





</body>
</html>