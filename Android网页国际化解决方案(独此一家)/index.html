<html>
<head>
	
	<title>Android网页国际化解决方案(独此一家)</title>
	<meta name="keywords" content="My Blog, Spider Bitch!" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<p>Android国际化是一个老生常谈的问题，主要是字符串资源的翻译，Android应用根据系统的语言显示应用中对应的文字资源，Android系统对此提供了原生支持。字符串一般放在<code>strings.xml</code>文件中，不同语言有不同的<code>strings.xml</code>文件，分别放置在各自的<code>values</code>文件夹中，为了区分不同的<code>values</code>文件夹，我们会在<code>values</code>的后面增加一个后缀，比如简体中文就是<code>values-zh-rCN</code>; 繁体中文是<code>values-zh-rTW</code>或者<code>values-zh-rHK</code>，分别表示中国大陆；中国台湾和中国香港，其他语言都会有相应的文件夹，他们又都归于<code>res</code>文件夹下。另外还会有个默认的文件夹，当没有找到相应的字符串资源时就会使用<code>values</code>文件夹下<code>string.xml</code>的字符串。</p>
<p>以上是Android字符串国际化的常用解决方式，但是本文讨论的不是常规的字符串国际化，而是Android中嵌入的网页的国际化。曾经不止一次遇到过以下需求：Android的<code>assets</code>目录下有一个<code>HTML</code>文件, 它是用来在电脑上显示的，也就是说，我们的应用具备与电脑交互的能力，通过网络(一般是局域网)，Android读取App中的HTML文件成为IO流，并创建一个Socket等待电脑的浏览器连接，当Socket连接成功后浏览器可以获取IO流，并编码成字符串文本，最后解析文本，渲染成网页显示出来。那么问题来了，我们只有一个HTML文件，文件里的语言是固定的，不能像Java代码中通过<code>getString(int id)</code>的方式根据系统语言读取指定的文字，造成HTML网页无法国际化的问题。</p>
<p>为了解决这个问题，我翻遍了整个互联网，几乎没有找到任何可靠的信息，基本都是讲第一段中的国际化。如今已经解决了这个问题，同时我也添加了<code>独此一家</code>的标记。</p>
<h4 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h4><ol>
<li>首先我们编写好正常的HTML网页，即字符串用英文，此时无论是谁访问都显示英文网页。</li>
<li>把网页中的字符串复制到<code>res/values/strings.xml</code>文件中，每个字符串命名一个id以示区别，注意只需要复制需要翻译的部分，并保证内容是一样的。然后就是在各个<code>values-xxx</code>文件夹的各自<code>strings.xml</code>文件中根据id将英语翻译成各种语言。</li>
<li><p>此时需要将HTML网页中的英文字符串动态替换成刚刚翻译的各种文字，这是最关键的一步。</p>
<p> 上文提到读取HTML文件，我们可以在读取该文件后再读取<code>res/values/strings.xml</code>文件，寻找strings.xml文件每个id对应的字符串文本是否在HTML文件中有相同的文本，之所以第二步中要求内容是一样的，因为在这里进行字符串比较。如果发现xml中的某个字符串与HTML中的字符串相同，这个时候我们去查找该字符串的id对应的int值，它在R文件中自动生成，比如它的值是6666, 那么我们用$6666替换HTML中的字符串，这里多了一个$符是因为之后解析会要用到。完成了这步再打开HTML文件，会看到像乱码一样的字符，因为文字都被$符加各种数字替换掉了。</p>
</li>
<li>到这一步大部分工作已经完成了。我们将新生成的HTML网页放入源码的<code>assets</code>文件夹中，Java读取它的时候根据每个$符截取到每个字符串对应的int值，然后有了这个int值就可以<code>getString(int id)</code>啦！！由于第二步中对应的字符串都是相同的id,所以它们的int值也是一样的，在<code>getString(int id)</code>的时候就可以获取到每种语言的文字了。</li>
</ol>
<p>到这里，我们发现电脑浏览器访问的网页都是Android即时动态生成的，而不是固定写在APK文件中的，浏览器得到的语言种类是Android系统语言的种类。比如Android使用中文简体，那么浏览器显示的就是中文；Android使用英文，浏览器显示的就是英文。网页国际化大功告成！</p>
<h4 id="代码实践"><a href="#代码实践" class="headerlink" title="代码实践"></a>代码实践</h4><p>以下是一段Python脚本，实现读取HTML文件和<code>res/values/strings.xml</code>文件，并匹配strings.xml中的字符串与HTML文件中的字符串，最后将$加字符串的id的int值替换掉HTML中对应的字符串。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python2</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> xml.parsers.expat;</div><div class="line"><span class="keyword">import</span> sys;</div><div class="line"><span class="keyword">import</span> re;</div><div class="line">parser=xml.parsers.expat.ParserCreate(<span class="string">'UTF-8'</span>);</div><div class="line"></div><div class="line">values_en = &#123;&#125;</div><div class="line">values_lang = &#123;&#125;</div><div class="line">values_hash = &#123;&#125;</div><div class="line">name=<span class="string">''</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(lang, values)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_element</span><span class="params">(n, attrs)</span>:</span></div><div class="line">    <span class="keyword">global</span> name;</div><div class="line">    <span class="keyword">if</span> n != <span class="string">u'string'</span>: <span class="keyword">return</span></div><div class="line">    name=attrs[<span class="string">u'name'</span>]</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">end_element</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">global</span> name;</div><div class="line">    name=<span class="string">''</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">char_data</span><span class="params">(value)</span>:</span></div><div class="line">    <span class="keyword">global</span> name;</div><div class="line">    <span class="keyword">if</span> name == <span class="string">''</span>: <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">in</span> values: values[name] = <span class="string">u''</span>;</div><div class="line">    values[name] += value;</div><div class="line">  p = xml.parsers.expat.ParserCreate()</div><div class="line">  p.StartElementHandler = start_element</div><div class="line">  p.EndElementHandler = end_element</div><div class="line">  p.CharacterDataHandler = char_data</div><div class="line">  <span class="keyword">if</span> lang == <span class="string">'en'</span>:</div><div class="line">    f=open(<span class="string">'&lt;ModeName&gt;/src/main/res/values/strings.xml'</span>);</div><div class="line">  <span class="keyword">else</span>:</div><div class="line">    f=open(<span class="string">'&lt;ModeName&gt;/src/main/res/values-%s/strings.xml'</span> % lang);</div><div class="line">  p.ParseFile(f);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_R</span><span class="params">(file, values)</span>:</span></div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> open(file):</div><div class="line">      match = re.search(<span class="string">".*public static final int (.*)=0x(.*);"</span>, line)</div><div class="line">      <span class="keyword">if</span> match:</div><div class="line">        values[match.group(<span class="number">1</span>)] = match.group(<span class="number">2</span>)</div><div class="line">  <span class="keyword">except</span>:</div><div class="line">    sys.exit(<span class="number">1</span>)</div><div class="line"></div><div class="line">parse(<span class="string">'en'</span>, values_en);</div><div class="line">parse_R(<span class="string">'&lt;ModeName&gt;/build/generated/source/r/debug/&lt;包名.注意用斜杠分隔&gt;/R.java'</span>, values_lang);</div><div class="line">page=open(<span class="string">'&lt;原HTML名&gt;.html'</span>).read();</div><div class="line"><span class="keyword">for</span> num,(key,orig) <span class="keyword">in</span> enumerate(</div><div class="line">         sorted(values_en.iteritems(),</div><div class="line">	        key=<span class="keyword">lambda</span> x:len(x[<span class="number">1</span>]), reverse=<span class="keyword">True</span>)):</div><div class="line">  <span class="keyword">if</span> <span class="keyword">not</span> key <span class="keyword">in</span> values_lang: <span class="keyword">continue</span>;</div><div class="line">  replacement = <span class="string">'##//$$$%s$$$//##'</span> % num;</div><div class="line">  values_hash[key] = replacement;</div><div class="line">  page = page.replace(orig, replacement);</div><div class="line"></div><div class="line"><span class="keyword">for</span> key,repl <span class="keyword">in</span> values_lang.iteritems():</div><div class="line">  <span class="keyword">if</span> <span class="keyword">not</span> key <span class="keyword">in</span> values_hash: <span class="keyword">continue</span>;</div><div class="line">  orig = values_hash[key];</div><div class="line">  replacement = <span class="string">'$'</span> + values_lang[key];</div><div class="line">  page = page.replace(orig, replacement);</div><div class="line">old = <span class="keyword">None</span></div><div class="line"><span class="keyword">try</span>:</div><div class="line">  old = open(<span class="string">"&lt;ModeName&gt;/src/main/res/raw/&lt;新HTML名&gt;.html"</span>).read();</div><div class="line"><span class="keyword">except</span>:</div><div class="line">  <span class="keyword">pass</span></div><div class="line"><span class="keyword">if</span> (old != page):</div><div class="line">  open(<span class="string">"WifiInput/src/main/res/raw/&lt;新HTML名&gt;.html"</span>, <span class="string">"w"</span>).write(page.encode(<span class="string">'UTF-8'</span>));</div></pre></td></tr></table></figure>
<p>注意以上用python2编译，同时在提示的地方修改成你自己的信息，代码并不复杂，很容易看懂。</p>
<p>下面是读取新生成的HTML,并解析HTML查找并替换成系统语言的字符串：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">String htmlpage;</div><div class="line">InputStream is = getResources().openRawResource(R.raw.&lt;新HTML名不加后缀&gt;);</div><div class="line"><span class="keyword">int</span> pagesize = <span class="number">32768</span>;<span class="comment">// 32KB</span></div><div class="line"><span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[pagesize];</div><div class="line">StringBuilder page;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        <span class="keyword">int</span> r = is.read(data, offset, pagesize - offset);</div><div class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        offset += r;</div><div class="line">        <span class="keyword">if</span> (offset &gt;= pagesize) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"page is too large to load"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    page = <span class="keyword">new</span> StringBuilder();</div><div class="line">    page.append(<span class="keyword">new</span> String(data, <span class="number">0</span>, offset));</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"failed to load html page"</span>, e);</div><div class="line">&#125;</div><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">    <span class="keyword">int</span> pos = page.indexOf(<span class="string">"$"</span>);</div><div class="line">    <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> res = Integer.parseInt(page.substring(pos + <span class="number">1</span>, pos + <span class="number">9</span>), <span class="number">16</span>);</div><div class="line">    page.replace(pos, pos + <span class="number">9</span>, getString(res));</div><div class="line">&#125;</div><div class="line">htmlpage = page.toString();</div></pre></td></tr></table></figure></p>
<p>先将HTML页面读入StringBuilder中，然后找到每个$符出现的位置，接着截取$后面的1~8位，这是一个10进制的数，转成十六进制，得到id值，最后<code>getString(int id)</code>用字符串替代掉数字。最后就只有网络操作啦！</p>
<p>其实在Android本地使用WebView显示网页并国际化也可以用这个方法。</p>
<p>OK，终于非常详细地讲解清楚啦！</p>





</body>
</html>