<html>
<head>
	
	<title>Android开发有用的几个反射案例</title>
	<meta name="keywords" content="My Blog, Spider Bitch!" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<p>对于系统隐藏的API由于标注了@hide 或者@private导致我们的应用无法直接调用，当需要相关功能的时候只能通过反射实现，以下是我收集的几个用过的反射案例。</p>
<h3 id="显示通知栏"><a href="#显示通知栏" class="headerlink" title="显示通知栏"></a>显示通知栏</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    Object sbservice = <span class="keyword">this</span>.getSystemService(<span class="string">"statusbar"</span>);<span class="comment">//忽略此处报错</span></div><div class="line">    Class&lt;?&gt; statusbarManager = Class.forName(<span class="string">"android.app.StatusBarManager"</span>);</div><div class="line">    Method showsb = statusbarManager.getMethod(<span class="string">"expandNotificationsPanel"</span>);</div><div class="line">showsb.invoke(sbservice);</div><div class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">&#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</div><div class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">&#125;</div><div class="line"><span class="comment">//需要申请权限</span></div><div class="line">&lt;uses-permission android:name=<span class="string">"android.permission.EXPAND_STATUS_BAR"</span>/&gt;</div></pre></td></tr></table></figure>
<h3 id="显示recent-Apps即最近使用App"><a href="#显示recent-Apps即最近使用App" class="headerlink" title="显示recent Apps即最近使用App"></a>显示recent Apps即最近使用App</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    Class serviceManagerClass = Class.forName(<span class="string">"android.os.ServiceManager"</span>);</div><div class="line">    Method getService = serviceManagerClass.getMethod(<span class="string">"getService"</span>, String.class);</div><div class="line">    IBinder retbinder = (IBinder) getService.invoke(serviceManagerClass, <span class="string">"statusbar"</span>);</div><div class="line">    Class statusBarClass = Class.forName(retbinder.getInterfaceDescriptor());</div><div class="line">    Object statusBarObject = statusBarClass.getClasses()[<span class="number">0</span>].getMethod(<span class="string">"asInterface"</span>, IBinder.class).invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; retbinder &#125;);</div><div class="line">    Method clearAll = statusBarClass.getMethod(<span class="string">"toggleRecentApps"</span>);</div><div class="line">    clearAll.setAccessible(<span class="keyword">true</span>);</div><div class="line">clearAll.invoke(statusBarObject);</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="禁止下拉状态栏显示通知栏："><a href="#禁止下拉状态栏显示通知栏：" class="headerlink" title="禁止下拉状态栏显示通知栏："></a>禁止下拉状态栏显示通知栏：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">WindowManager wmanager = ((WindowManager) getApplicationContext().getSystemService(Context.WINDOW_SERVICE));</div><div class="line"><span class="comment">// statusbar blocker configuration</span></div><div class="line">WindowManager.LayoutParams localLayoutParams = <span class="keyword">new</span> WindowManager.LayoutParams();</div><div class="line">localLayoutParams.type = WindowManager.LayoutParams.TYPE_SYSTEM_ERROR;</div><div class="line">localLayoutParams.gravity = Gravity.TOP;</div><div class="line">localLayoutParams.flags = WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |</div><div class="line"><span class="comment">// this is to enable the notification to recieve touch events</span></div><div class="line">WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL |</div><div class="line"><span class="comment">// Draws over status bar</span></div><div class="line">WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN;</div><div class="line"><span class="comment">// set the size of statusbar blocker</span></div><div class="line">localLayoutParams.width = WindowManager.LayoutParams.MATCH_PARENT;</div><div class="line">localLayoutParams.height = (<span class="keyword">int</span>) (<span class="number">25</span> * getResources().getDisplayMetrics().scaledDensity);<span class="comment">//25 * 2</span></div><div class="line">localLayoutParams.format = PixelFormat.TRANSLUCENT;</div><div class="line">View view = <span class="keyword">new</span> FrameLayout(<span class="keyword">this</span>);</div><div class="line">wmanager.addView(view, localLayoutParams);</div><div class="line"><span class="comment">//申请权限</span></div><div class="line">&lt;uses-permission android:name=<span class="string">"android.permission.SYSTEM_ALERT_WINDOW"</span>/&gt;</div></pre></td></tr></table></figure>
<h3 id="显示导航栏右侧三个点的Menu-key-这个功能早已废弃，但是通过反射依然可以实现，据反映在有些机型上出现了适配问题。"><a href="#显示导航栏右侧三个点的Menu-key-这个功能早已废弃，但是通过反射依然可以实现，据反映在有些机型上出现了适配问题。" class="headerlink" title="显示导航栏右侧三个点的Menu key 这个功能早已废弃，但是通过反射依然可以实现，据反映在有些机型上出现了适配问题。"></a>显示导航栏右侧三个点的Menu key 这个功能早已废弃，但是通过反射依然可以实现，据反映在有些机型上出现了适配问题。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setNeedsMenuKey</span><span class="params">()</span> </span>&#123;</div><div class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.LOLLIPOP) &#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">int</span> flags = WindowManager.LayoutParams.class.getField(<span class="string">"FLAG_NEEDS_MENU_KEY"</span>).getInt(<span class="keyword">null</span>);</div><div class="line">            getWindow().addFlags(flags);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException | NoSuchFieldException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">            Method setNeedsMenuKey = Window.class.getDeclaredMethod(<span class="string">"setNeedsMenuKey"</span>, <span class="keyword">int</span>.class);</div><div class="line">            setNeedsMenuKey.setAccessible(<span class="keyword">true</span>);</div><div class="line"><span class="keyword">int</span> value = WindowManager.LayoutParams.class.getField(<span class="string">"NEEDS_MENU_SET_TRUE"</span>).getInt(<span class="keyword">null</span>);</div><div class="line">            setNeedsMenuKey.invoke(getWindow(), value);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException | NoSuchFieldException | IllegalAccessException | InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>点击事件 当点击Menu key时会回调以下方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreatePanelMenu</span><span class="params">(<span class="keyword">int</span> featureId, Menu menu)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;<span class="comment">// 必须return false,否则系统只会回调一次</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>





</body>
</html>