<html>
<head>
	
	<title>AccessibilityService原理与应用(一)</title>
	<meta name="keywords" content="My Blog, Spider Bitch!" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<p><code>accessibility service</code>是主要用于为残障人士与设备交互的系统服务，比如为失明者和驾驶者提供语音反馈，开发者还可以自定义自己的辅助服务，实现特定的功能。然而国内开发者已经将这一系统特性彻底用歪了，比如最近两年各种抢红包插件、应用自动安装等。</p>
<h5 id="AccessibilityServic用法"><a href="#AccessibilityServic用法" class="headerlink" title="AccessibilityServic用法"></a>AccessibilityServic用法</h5><ol>
<li><p>清单文件定义和权限申明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;service android:name=&quot;.MyAccessibilityService&quot;</div><div class="line">    android:permission=&quot;android.permission.BIND_ACCESSIBILITY_SERVICE&quot;</div><div class="line">    android:label=&quot;@string/accessibility_service_label&quot;&gt;</div><div class="line">    &lt;intent-filter&gt;</div><div class="line">        &lt;action android:name=&quot;android.accessibilityservice.AccessibilityService&quot; /&gt;</div><div class="line">    &lt;/intent-filter&gt;</div><div class="line">    &lt;meta-data</div><div class="line">        android:name=&quot;android.accessibilityservice&quot;</div><div class="line">        android:resource=&quot;@xml/accessibility_service_config&quot;/&gt;</div><div class="line">&lt;/service&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>创建服务配置文件在<project_dir>/res/xml/accessibility_service_config.xml：</project_dir></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;accessibility-service xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:description=&quot;@string/accessibility_service_description&quot;</div><div class="line">    android:packageNames=&quot;com.example.android.apis&quot;</div><div class="line">    android:accessibilityEventTypes=&quot;typeAllMask&quot;</div><div class="line">    android:accessibilityFlags=&quot;flagDefault&quot;</div><div class="line">    android:accessibilityFeedbackType=&quot;feedbackSpoken&quot;</div><div class="line">    android:notificationTimeout=&quot;100&quot;</div><div class="line">    android:canRetrieveWindowContent=&quot;true&quot;</div><div class="line">    android:settingsActivity=&quot;com.example.android.accessibility.ServiceSettingsActivity&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><code>description</code>为用户允许应用使用辅助功能的说明文字，<code>packageNames</code>指定需要辅助的应用的包名，<code>accessibilityEventTypes</code>是设置事件的响应类型，<code>accessibilityFeedbackType</code>是设置回馈给用户的方式，有语音和震动。常用以下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">android:description</div><div class="line">android:packageNames</div><div class="line">android:accessibilityEventTypes</div><div class="line">android:accessibilityFlags</div><div class="line">android:accessibilityFeedbackType</div><div class="line">android:notificationTimeout</div><div class="line">android:canRetrieveWindowContent</div><div class="line">android:settingsActivity</div></pre></td></tr></table></figure></p>
<ol>
<li><p>继承<code>AccessibilityService</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAccessibilityService</span> <span class="keyword">extends</span> <span class="title">AccessibilityService</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     *  必须重写的方法：此方法用了接受系统发来的event。在你注册的event发生是被调用。在整个生命周期会被调用多次。</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAccessibilityEvent</span><span class="params">(AccessibilityEvent event)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">     *  必须重写的方法：系统要中断此service返回的响应时会调用。在整个生命周期会被调用多次。</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInterrupt</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     <span class="comment">/**</span></div><div class="line">     *  当系统连接上你的服务时被调用</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onServiceConnected();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     *  在系统要关闭此service时调用。</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>最后，回到服务类<code>MyAccessibilityService</code>,在<code>onAccessibilityEvent(AccessibilityEvent event)</code>方法中，我们可以接收到系统发过来的事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAccessibilityEvent</span><span class="params">(AccessibilityEvent event)</span> </span>&#123;</div><div class="line">   <span class="comment">//得到事件的包名。如果注册了多个应用的事件，可以在此做一个判断。</span></div><div class="line">   String packageName = event.getPackageName().toString();</div><div class="line"></div><div class="line">   <span class="comment">//得到对应的事件类型，这里有很多很多种的事件类型，具体可以自行翻阅AccessibilityEvent类中的定义。</span></div><div class="line">   <span class="keyword">int</span> eventType = event.getEventType();</div><div class="line"></div><div class="line">   <span class="comment">//得到根的view节点。可以当做当前acitivity的视图看成是树状结构的（实际上也是~。~），而我们现在就得到了它的根节点。</span></div><div class="line">   AccessibilityNodeInfo root = getRootInActiveWindow();</div><div class="line"></div><div class="line">   <span class="comment">//我们可以得到此节点的文字</span></div><div class="line">   String rootText = root.getText().toString();</div><div class="line">   <span class="comment">//得到此节点的class</span></div><div class="line">   String rootClass = root.getClass().toString();</div><div class="line">   <span class="comment">//得到子节点的和子节点总数</span></div><div class="line">   root.getChild(root.getChildCount()-<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>到这里，我们可以通过无数次遍历，找到视图上自己想要的那个控件了。当然，还有更加简单的方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//这两个方法如果找不到的话，都会报错。所以请做好对应的处理。</span></div><div class="line">    root.findAccessibilityNodeInfosByText(<span class="string">"根据文本内容查找节点"</span>);</div><div class="line">    root.findAccessibilityNodeInfosByViewId(<span class="string">"根据id查找节点，当然实际上很难知道id是多少~、~"</span>);</div></pre></td></tr></table></figure></p>
<p>最后我们可以对控件做一些操作,比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//点击操作</div><div class="line">root.performAction(AccessibilityNodeInfo.ACTION_CLICK);</div><div class="line"></div><div class="line">//滑动操作</div><div class="line">root.performAction(AccessibilityNodeInfo.ACTION_SCROLL_BACKWARD);</div></pre></td></tr></table></figure></p>





</body>
</html>